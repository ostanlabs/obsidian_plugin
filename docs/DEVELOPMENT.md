# Canvas Accomplishments - Development Guide

## Quick Start

```bash
# Install dependencies
make install

# Build plugin
make build

# Deploy to your vault
make deploy VAULT_PATH=/path/to/vault
```

## Development Workflow

### 1. Setup Development Environment

```bash
# Create symlink to vault (one-time setup)
make link VAULT_PATH=/path/to/vault

# Start watch mode for auto-rebuild
make watch
```

### 2. Making Changes

1. Edit source files in `main.ts`, `util/`, `notion/`, etc.
2. Watch mode will automatically rebuild
3. In Obsidian, reload plugin (Ctrl+R with debug mode enabled)
4. Test changes

### 3. Testing

```bash
# Run tests once
make test

# Run tests in watch mode
make test-watch

# Run linter
make lint

# Format code
make format

# Run all checks
make check
```

## Architecture

### Core Components

1. **main.ts**: Plugin entry point, command registration, orchestration
2. **settings.ts**: Settings UI and configuration management
3. **types.ts**: TypeScript interfaces and type definitions

### Utility Modules

- **util/canvas.ts**: Canvas JSON manipulation
- **util/frontmatter.ts**: YAML frontmatter parsing/serialization
- **util/idGenerator.ts**: ID generation and scanning
- **util/logger.ts**: Logging to console and file
- **util/template.ts**: Template processing and placeholders

### UI Components

- **ui/ItemCreationModal.ts**: Modal for creating new items

### Integration

- **notion/notionClient.ts**: Notion API wrapper

## Key Concepts

### Canvas Manipulation

Canvas files are JSON with this structure:

```json
{
  "nodes": [
    {
      "id": "unique-id",
      "type": "text|file|link|group",
      "x": 0,
      "y": 0,
      "width": 250,
      "height": 60,
      "text": "...",
      "file": "path/to/file.md"
    }
  ],
  "edges": [
    {
      "id": "edge-id",
      "fromNode": "node-id",
      "fromSide": "right",
      "toNode": "node-id",
      "toSide": "left"
    }
  ]
}
```

We read/write this JSON directly rather than using Canvas internal APIs.

### ID Generation

IDs are generated by:
1. Scanning all markdown files in vault
2. Reading frontmatter `id` field
3. Finding highest number for each prefix
4. Incrementing by 1

This approach is resilient and doesn't require state files.

### Template System

Templates use `{{placeholder}}` syntax:
- Loaded from vault files
- Placeholders replaced with actual values
- Default templates embedded in plugin code

### Notion Sync

- Uses official `@notionhq/client` library
- One-way sync: Obsidian → Notion
- Stores Notion page ID in frontmatter
- Creates/updates pages based on presence of page ID

## Adding New Features

### Adding a New Command

```typescript
// In main.ts registerCommands()
this.addCommand({
  id: "your-command-id",
  name: "Your Command Name",
  callback: async () => {
    await this.yourCommandHandler();
  },
});
```

### Adding a New Setting

```typescript
// 1. Add to types.ts interface
export interface CanvasItemFromTemplateSettings {
  // ... existing settings
  yourNewSetting: string;
}

// 2. Add to DEFAULT_SETTINGS in types.ts
export const DEFAULT_SETTINGS = {
  // ... existing defaults
  yourNewSetting: "default value",
};

// 3. Add UI in settings.ts display()
new Setting(containerEl)
  .setName("Your Setting")
  .setDesc("Description")
  .addText((text) =>
    text
      .setValue(this.plugin.settings.yourNewSetting)
      .onChange(async (value) => {
        this.plugin.settings.yourNewSetting = value;
        await this.plugin.saveSettings();
      })
  );
```

### Adding a New Template Placeholder

```typescript
// In util/template.ts replacePlaceholders()
result = result.replace(/\{\{your_placeholder\}\}/g, frontmatter.yourField);
```

### Adding a New Notion Property

```typescript
// In notion/notionClient.ts createDatabase()
// Add to properties object:
"Your Property": {
  rich_text: {}, // or select, date, etc.
},

// In notion/notionClient.ts buildProperties()
// Add to properties object:
"Your Property": {
  rich_text: [
    {
      text: {
        content: frontmatter.yourField,
      },
    },
  ],
},
```

## Testing Guidelines

### Unit Tests

Place tests in `tests/` directory with `.test.ts` extension.

```typescript
import { yourFunction } from "../util/yourModule";

describe("YourModule", () => {
  describe("yourFunction", () => {
    it("should do something", () => {
      const result = yourFunction("input");
      expect(result).toBe("expected");
    });
  });
});
```

### Mocking Obsidian API

```typescript
const mockApp: any = {
  vault: {
    read: jest.fn(),
    write: jest.fn(),
  },
  // ... other methods
};
```

## Debugging

### Enable Debug Mode

1. Obsidian Settings → Community Plugins → Canvas Accomplishments
2. Enable "Show debug info" (if available)
3. Open Developer Tools: Ctrl+Shift+I (Cmd+Opt+I on Mac)

### View Logs

```bash
# In vault
cat .obsidian/plugins/canvas-accomplishments/plugin.log

# Or tail in real-time
tail -f .obsidian/plugins/canvas-accomplishments/plugin.log
```

### Add Debug Logging

```typescript
await this.logger?.debug("Debug message", { data: someData });
await this.logger?.info("Info message");
await this.logger?.warn("Warning message");
await this.logger?.error("Error message", error);
```

## Performance Considerations

### ID Generation
- Scans all markdown files on each ID generation
- For large vaults (1000+ files), consider caching
- Current implementation is acceptable for most use cases

### Canvas Updates
- Reading/writing JSON is fast
- No performance issues expected

### Notion API
- Rate limited by Notion (3 requests/second)
- Plugin doesn't batch requests in v1
- Future: implement request queue

## Code Style

### TypeScript
- Use strict typing
- Avoid `any` where possible
- Document complex functions

### Formatting
- Tabs for indentation (Obsidian convention)
- Run `make format` before committing

### Naming
- camelCase for functions and variables
- PascalCase for classes and interfaces
- UPPER_SNAKE_CASE for constants

## Release Process

### Version Bump

```bash
# Patch version (1.0.X)
make version-patch

# Minor version (1.X.0)
make version-minor

# Major version (X.0.0)
make version-major
```

### Build Release

```bash
# Clean build
make dist

# Verify files
ls -la main.js manifest.json
```

### Testing Checklist

- [ ] All tests pass (`make test`)
- [ ] Linter passes (`make lint`)
- [ ] Manual testing in Obsidian
- [ ] Test with fresh vault
- [ ] Test Notion integration
- [ ] Test template generation
- [ ] Test ID generation with existing notes

## Common Issues

### TypeScript Errors

```bash
# Check types
npx tsc --noEmit

# Fix with linter
make lint-fix
```

### Plugin Not Loading

- Check console for errors
- Verify `main.js` is up to date
- Check `manifest.json` is valid JSON
- Restart Obsidian

### Tests Failing

- Clear Jest cache: `npx jest --clearCache`
- Check mock data matches interfaces
- Verify imports are correct

## Resources

- [Obsidian Plugin Developer Docs](https://docs.obsidian.md/Plugins/Getting+started/Build+a+plugin)
- [Obsidian API Reference](https://github.com/obsidianmd/obsidian-api)
- [Notion API Documentation](https://developers.notion.com/)
- [Canvas Format Spec](https://jsoncanvas.org/)

## Getting Help

- Check logs: `.obsidian/plugins/canvas-accomplishments/plugin.log`
- Console errors: Ctrl+Shift+I → Console tab
- Review test files for usage examples
- Check GitHub issues

