# Plugin Spec: Canvas Item From Template + Notion Sync

## 1. Overview

**Goal**  
Provide an Obsidian plugin that lets the user, while working on a Canvas, create **Task** or **Accomplishment** notes from templates, attach them to canvas nodes, and **sync them to Notion** out of the box when the user provides Notion credentials.

Core capabilities:

1. From Canvas, create a **Task** or **Accomplishment** note from a template via a modal (dropdown selection), and convert the node into a file node pointing to that note.
2. Generated markdown notes contain structured **frontmatter** (type, effort, IDs, etc.) based on the chosen template.
3. Plugin can **initialize and manage a Notion database** for these items, using user-provided Notion credentials and a parent Notion page.
4. Items created or updated in Obsidian can be **synced to Notion** automatically or on demand.
5. **Effort avenues** and templates ship with defaults but are fully **user-extendable** via settings.

Notion becomes the structured external database; Obsidian Canvas and markdown remain the primary modeling and authoring surface.

---

## 2. Assumptions & Context

- Obsidian core Canvas (or Advanced Canvas) is used for visual DAGs.
- Canvas files are stored as `.canvas` JSON (JSON Canvas format).
- The plugin is written in TypeScript using the Obsidian plugin API.
- The user has (or will have) a visual grammar roughly like:
  - **Type**: Task vs Accomplishment (mini-milestone).
  - **Effort Avenue**: Business / Infra / Engineering / Research (extendable).
- Notion integration uses:
  - A user-provided **Notion integration token**.
  - A user-provided **Notion parent page ID** where the plugin will create a database.
  - Notion **public API** via a JS client (e.g., `@notionhq/client`) or direct fetch calls.
- Sync direction for v1: **Obsidian → Notion** is the primary path.
  - Notion is treated as a mirror / dashboard.
  - Optional future: partial Notion → Obsidian sync.

Out of scope for v1:
- Multi-DB Notion setups.
- Arbitrary user-defined Notion schemas (we generate a standard schema but keep it minimally extensible).

---

## 3. Key Concepts

### 3.1 Item Type

Two primary item types:

- **Task**: atomic unit of work. Usually a prerequisite for an accomplishment.
- **Accomplishment**: mini-milestone / outcome checkpoint. Aggregates tasks and dependencies.

Represented in frontmatter as:

```yaml
type: task | accomplishment
```

### 3.2 Effort Avenue

Categorization axis for who/what kind of work:

- `Business`
- `Infra`
- `Engineering`
- `Research`

User can extend this list (e.g., `Design`, `Ops`).

Represented in frontmatter as:

```yaml
effort: Business | Infra | Engineering | Research | <custom>
```

### 3.3 Dependencies & Relationships

- Dependencies are modeled in frontmatter as:
  ```yaml
  depends_on:
    - A001
    - T015
  ```
- Parent-child relationships (Task → Accomplishment) can be modeled with:
  ```yaml
  parent: A001
  ```

These can be reflected in Notion relations but that part is out-of-band from this plugin’s core responsibilities; it will set properties that Notion DB schema supports.

---

## 4. Visual Grammar (Canvas Reference)

_Not enforced in v1 but used as a mental model and future extension target._

- **Type → Shape** (recommended convention):
  - Task: rectangle
  - Accomplishment: pill/terminal
- **Effort Avenue → Color**:
  - Business: purple
  - Infra: orange
  - Engineering: blue
  - Research: green
- **Dependency direction**:
  - `A → B` means **A must occur before B** (B depends on A).

V1 plugin only cares about the **selected node** and the user’s chosen type/effort in the modal; later versions can infer type/effort from shape/color automatically.

---

## 5. Data Model & Frontmatter Schema

Each generated note will have frontmatter like:

```yaml
---
type: task | accomplishment
title: <string>
effort: <string>             # one of Effort options from settings
id: <string>                 # e.g. T001, A005
parent: <string>             # optional; for tasks → accomplishment link
status: todo | in_progress | done | blocked  # (initial default: todo)
priority: low | medium | high | critical     # (optional)
created: <ISO timestamp>
updated: <ISO timestamp>     # can be maintained by plugin or other tools
canvas_source: <path/to/canvas.canvas>
vault_path: <path/to/note.md>
notion_page_id: <Notion page ID or empty>
---
```

Notes:

- `id` is generated by the plugin using per-prefix counters.
- `canvas_source` and `vault_path` help with debugging and cross-referencing.
- `notion_page_id` is stored for linking the Obsidian note to the corresponding Notion page.

---

## 6. Templates

The plugin ships with **default templates** for Task and Accomplishment, but the user can:
- change which template files are used via settings, and
- edit those template files freely.

### 6.1 Template Location & Extendability

Settings specify:

```ts
taskTemplatePath: string;           // e.g. "Templates/canvas-task-template.md"
accomplishmentTemplatePath: string; // e.g. "Templates/canvas-accomplishment-template.md"
```

Behavior:

- On first run, if these files don’t exist, the plugin will:
  - create a `Templates/` folder if needed;
  - write default templates to the specified paths;
  - notify the user that templates were created and are editable.
- User can edit templates to change:
  - frontmatter fields and defaults,
  - body structure (sections, checklists, etc.),
  - add their own placeholders (see below).

### 6.2 Template Placeholders

Placeholders use `{{placeholder}}` syntax. Supported v1 placeholders:

- `{{title}}`
- `{{type}}`
- `{{effort}}`
- `{{id}}`
- `{{parent}}`
- `{{status}}`
- `{{priority}}`
- `{{created}}`
- `{{updated}}`
- `{{canvas_source}}`
- `{{vault_path}}`
- `{{notion_page_id}}` (initially empty)

The plugin replaces these placeholders before writing the note to disk.

### 6.3 Default Templates

**Task Template (default)**

```markdown
---
type: {{type}}
title: {{title}}
effort: {{effort}}
id: {{id}}
parent: {{parent}}
status: todo
priority: medium
created: {{created}}
updated: {{updated}}
canvas_source: {{canvas_source}}
vault_path: {{vault_path}}
notion_page_id: {{notion_page_id}}
---

# {{title}} (Task)

## Objective

Describe what needs to be achieved.

## Steps

- [ ] Step 1
- [ ] Step 2

## Notes

- ...
```

**Accomplishment Template (default)**

```markdown
---
type: {{type}}
title: {{title}}
effort: {{effort}}
id: {{id}}
status: todo
priority: high
created: {{created}}
updated: {{updated}}
canvas_source: {{canvas_source}}
vault_path: {{vault_path}}
notion_page_id: {{notion_page_id}}
---

# {{title}} (Accomplishment)

## Outcome

Describe the final state that will be true once this is done.

## Acceptance Criteria

- [ ] Criterion 1
- [ ] Criterion 2

## Related Tasks

- [ ] Link tasks here

## Notes

- ...
```

---

## 7. Effort Avenues (Defaults & Extendability)

Settings include:

```ts
effortOptions: string[];      // default: ["Business", "Infra", "Engineering", "Research"]
defaultEffort: string;        // default: "Engineering"
```

- User can add/remove effort avenues in the settings UI (comma-separated list or multi-line input).
- These options populate the **Effort** dropdown in the item creation modal.
- The selected effort is written into frontmatter and used as the default value for Notion’s **Effort** property.

If the user later changes the list, the plugin does not retroactively update existing notes/Notion entries (v1).

---

## 8. Notion Integration

### 8.1 Goals

- Let the user provide Notion credentials and a parent page ID.
- Plugin creates a **dedicated Notion database** for Canvas items with fields matching the frontmatter schema as closely as possible.
- When a note is created (Task or Accomplishment), plugin creates a corresponding page in Notion DB.
- When a note is updated in Obsidian, user can sync changes to Notion (automatic on save or via command in v1).

### 8.2 Notion Configuration (Settings)

Settings section:

```ts
interface NotionSettings {
  enabled: boolean;
  integrationToken: string;   // Notion internal integration secret
  parentPageId: string;       // Notion page ID where DB will be created
  databaseId: string;         // Filled after initialization
  syncOnNoteCreate: boolean;  // default: true
  syncOnDemandOnly: boolean;  // default: false (if true, only manual sync)
}
```

In plugin Settings tab:

- Toggle `Enable Notion Sync`.
- Text input `Integration Token` (masked).
- Text input `Parent Page ID`.
- Button: **“Initialize Notion Database”**.

### 8.3 Notion Database Initialization

Command / button: **“Initialize Notion Database”**

Behavior:

1. Validate `integrationToken` and `parentPageId` are provided.
2. Call Notion API to create a database with parent set to `parentPageId`.
3. Database name: e.g., `"Obsidian Canvas Items"` (configurable later).
4. Database properties (minimal v1):

   - `Name` (title) — maps to note title.
   - `Type` (select) — options: `Task`, `Accomplishment`.
   - `Effort` (select) — options from `effortOptions` setting.
   - `ID` (rich_text or unique formula) — note’s `id` field.
   - `Status` (select) — `todo`, `in_progress`, `done`, `blocked`.
   - `Priority` (select) — `low`, `medium`, `high`, `critical`.
   - `Parent` (rich_text or relation, v1: rich_text with parent ID string).
   - `Canvas Source` (rich_text) — `canvas_source` path.
   - `Vault Path` (rich_text) — `vault_path` path.
   - `Last Synced` (date) — last sync timestamp.

5. Save created `databaseId` into `NotionSettings.databaseId`.
6. Display success / error messages.

v1 will not attempt to reconcile existing DB schemas; it always creates a new DB and stores its ID.

### 8.4 Notion Sync Behavior

#### 8.4.1 On Note Creation

If Notion sync is enabled and `syncOnNoteCreate` is true:

1. After creating a new note from a Canvas node and saving to disk:
   - Build a Notion page payload using frontmatter fields.
   - If `databaseId` is present, call `notion.pages.create` with parent set to this DB.
   - Map frontmatter fields to Notion properties.
2. Store returned `page.id` in `notion_page_id` in the note frontmatter.
3. Optionally show a small toast “Synced to Notion: <DB name>”.

If Notion settings are invalid or `databaseId` missing:
- Skip sync and show a warning.

#### 8.4.2 Manual Sync Command

Additional command:

- ID: `canvas-item-from-template:sync-note-to-notion`
- Name: **“Canvas Item: Sync Current Note to Notion”**

Behavior:

1. Ensure active file is a note with frontmatter `type: task | accomplishment`.
2. Check Notion is enabled and database is initialized.
3. If `notion_page_id` is present:
   - Update existing page via `notion.pages.update`.
4. Else:
   - Create a new page as in “On Note Creation” and fill `notion_page_id`.

Mapping should be idempotent: multiple syncs for the same note update the same Notion page.

#### 8.4.3 Sync Scope (v1)

- **One-way**: Obsidian → Notion only.
- Plugin does not pull or merge changes from Notion back into Obsidian in v1.
- If fields diverge, Obsidian is the source of truth when user triggers sync.

---

## 9. Commands & UI (Updated)

### 9.1 Canvas-Related Commands

1. `create-item-from-selected-node`
   - Name: **“Canvas: Create Item From Template (Selected Node)”**
   - Requires: active Canvas, at least one node selected.
   - Shows modal (Type / Effort / Title) → creates note → converts node to file node → optional Notion sync.

2. `new-item-at-position`
   - Name: **“Canvas: New Item From Template (Center/Click Position)”**
   - Requires: active Canvas.
   - Shows modal → creates a new node + note → optional Notion sync.

### 9.2 Notion-Related Commands

3. `initialize-notion-database`
   - Name: **“Canvas Item: Initialize Notion Database”**
   - Opens confirmation → creates DB as described in 8.3.

4. `sync-current-note-to-notion`
   - Name: **“Canvas Item: Sync Current Note to Notion”**
   - Works on active markdown note.

### 9.3 Modal UI (Updated)

Fields:

- `Type` dropdown:
  - `Task`
  - `Accomplishment`
- `Effort` dropdown:
  - Values from `effortOptions` (user-extensible).
- `Title` text input:
  - Default: selected node’s text (first line).
- (Optional future) `Status`, `Priority` etc.

If Notion is enabled and DB is initialized, modal may show a small note: “Will sync to Notion on create”.

---

## 10. Settings / Configuration (Complete)

### 10.1 Core Plugin Settings

```ts
interface CanvasItemFromTemplateSettings {
  notesBaseFolder: string;
  taskTemplatePath: string;
  accomplishmentTemplatePath: string;
  idPrefixTask: string;
  idPrefixAccomplishment: string;
  idZeroPadLength: number;
  effortOptions: string[];
  defaultEffort: string;
  inferBaseFolderFromCanvas: boolean;
  // Notion
  notionEnabled: boolean;
  notionIntegrationToken: string;
  notionParentPageId: string;
  notionDatabaseId: string;
  syncOnNoteCreate: boolean;
  syncOnDemandOnly: boolean;
}
```

Default values:

```ts
const DEFAULT_SETTINGS: CanvasItemFromTemplateSettings = {
  notesBaseFolder: "Projects",
  taskTemplatePath: "Templates/canvas-task-template.md",
  accomplishmentTemplatePath: "Templates/canvas-accomplishment-template.md",
  idPrefixTask: "T",
  idPrefixAccomplishment: "A",
  idZeroPadLength: 3,
  effortOptions: ["Business", "Infra", "Engineering", "Research"],
  defaultEffort: "Engineering",
  inferBaseFolderFromCanvas: true,
  notionEnabled: false,
  notionIntegrationToken: "",
  notionParentPageId: "",
  notionDatabaseId: "",
  syncOnNoteCreate: true,
  syncOnDemandOnly: false,
};
```

### 10.2 Settings Tab UI

Sections:

1. **General**
   - Notes base folder (text).
   - Toggle: “Infer base folder from canvas location”.
2. **Templates**
   - Task template path (file selector / text).
   - Accomplishment template path (file selector / text).
   - Button: “Regenerate default templates” (with confirmation).
3. **IDs**
   - Task ID prefix, Accomplishment ID prefix.
   - Zero-padding length.
4. **Effort Avenues**
   - Multi-line input listing options.
   - Dropdown for default effort.
5. **Notion Integration**
   - Toggle: “Enable Notion Sync”.
   - Integration token (password input).
   - Parent page ID (text).
   - Database ID (readonly or editable once created).
   - Button: “Initialize Notion Database”.
   - Toggle: “Sync on note creation”.
   - Toggle: “Only sync on manual command (disable automatic sync)”.

---

## 11. Canvas Integration Details

### 11.1 Getting Active Canvas

Same as earlier:

```ts
getActiveCanvasView(): any | null {
  const leaves = this.app.workspace.getLeavesOfType("canvas");
  if (leaves.length === 0) return null;
  const activeLeaf = this.app.workspace.getMostRecentLeaf();
  const leaf = leaves.find((l) => l === activeLeaf) ?? leaves[0];
  return leaf.view;
}
```

### 11.2 Node Handling

- Selected node:
  - Access via canvasView API (depends on internal structure; likely `canvasView.canvas.selection` etc.).
- Converting node:
  - Change `node.type` to `"file"`.
  - Set `node.file` to relative path of newly created note.
  - Keep or update `node.text` as note title.
- Creating new node:
  - Use canvas view methods to add a new node at the center or click position.
  - Immediately convert it to file node associated with the created note.

After modifications, request canvas save:

```ts
canvasView.canvas.requestSave();
```

(Exact method name may differ; should match Canvas internal API.)

---

## 12. Notion Client Integration

In `main.ts` or a `notion.ts` helper module:

- Instantiate a Notion client only when `notionEnabled` is true and `integrationToken` is provided.
- Provide helper functions:
  - `createDatabase(settings: CanvasItemFromTemplateSettings): Promise<string>`
  - `createPageFromNote(frontmatter, settings): Promise<string>`
  - `updatePageFromNote(frontmatter, settings): Promise<void>`

Mapping notes:

- `title` → Notion `Name` property (title).
- `type` → Notion `Type` (select).
- `effort` → Notion `Effort` (select).
- `id` → Notion `ID` (rich_text).
- `status` → Notion `Status` (select).
- `priority` → Notion `Priority` (select).
- `parent` → Notion `Parent` (rich_text for v1).
- `canvas_source` → `Canvas Source` (rich_text).
- `vault_path` → `Vault Path` (rich_text).
- `Last Synced` set to now on each sync.

---

## 13. Edge Cases & Error Handling

- No active canvas → disable canvas commands or show “No active Canvas found” notice.
- No node selected in selected-node mode → show “No node selected” notice.
- Node already a file node → show “Node already linked to file”; abort.
- Template missing → show “Template not found” and provide a button to regenerate defaults.
- Notion enabled but DB not initialized → warn and skip sync.
- Notion API errors → show clear notices with error messages (rate limits, invalid token, etc.).
- ID generation issues → if prefix not set, fall back to `"T"` / `"A"`; if index file corrupt, reset from scanning existing notes (future enhancement).

---

## 14. File Layout

```txt
canvas-item-from-template/
  manifest.json
  main.ts
  settings.ts
  ui/
    ItemCreationModal.ts
  notion/
    notionClient.ts
  util/
    template.ts
    idGenerator.ts
    frontmatter.ts
  README.md
```

---

## 15. v1 Deliverables

For implementation in Cursor:

1. Full plugin skeleton:
   - `manifest.json`
   - `main.ts` with settings, commands, Canvas integration hooks.
2. Default template files generation logic.
3. ItemCreationModal for Type/Effort/Title selection.
4. Note creation from templates with frontmatter placeholder replacement.
5. Node → file-node conversion on Canvas.
6. Notion settings, DB initialization, and basic create/update sync implementation.
7. README describing setup, configuration, and workflows.

This spec should be enough for a first fully working version, with clear extension points for future improvements (shape/color inference, richer Notion mapping, bidirectional sync, etc.).
